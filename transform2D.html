<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Transform</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 1px solid #ccc;
            margin-top: 20px;
        }
        input, button, select {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>2D 影像幾何轉換工具</h1>
    <input type="file" id="upload" accept="image/*">
    <div>
        <label>X:</label><input type="number" id="translateX" value="0">
        <label>Y:</label><input type="number" id="translateY" value="0">
        <button onclick="applyTranslation()">平移</button>
    </div>
    <div>
        <label>翻轉:</label>
        <select id="flip">
            <option value="none">無</option>
            <option value="horizontal">水平</option>
            <option value="vertical">垂直</option>
        </select>
        <button onclick="applyFlip()">翻轉</button>
    </div>
    <div>
        <label>角度:</label><input type="number" id="rotateAngle" value="0" max="90" min="-90">
        <button onclick="applyRotation()">旋轉</button>
    </div>
    <div>
        <label>Shear:</label><input type="number" id="shearValue" value="0">
        <button onclick="applyShear()">錯切</button>
    </div>
    <div>
        <button onclick="applyFisheye()">魚眼</button>
        <button onclick="resetTransform()">正轉換</button>
    </div>
    <canvas id="canvas" width="500" height="500"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        let originalImageData = null;

        document.getElementById('upload').addEventListener('change', function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        img.onload = function () {
            resetImage();
        };

        function resetImage() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, img.width, img.height);
            originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }

        function resetTransform() {
            resetImage();
        }

        function drawImageWithReset(callback) {
            resetImage(); // 每次執行功能前重置圖片
            callback();   // 執行功能的具體邏輯
        }

        function applyTranslation() {
            const translateX = parseInt(document.getElementById('translateX').value) || 0;
            const translateY = parseInt(document.getElementById('translateY').value) || 0;

            drawImageWithReset(() => {
                ctx.save();
                ctx.translate(translateX, translateY);
                ctx.drawImage(img, 0, 0, img.width, img.height);
                ctx.restore();
            });
        }

        function applyFlip() {
            const flipDirection = document.getElementById('flip').value;

            drawImageWithReset(() => {
                ctx.save();
                if (flipDirection === 'horizontal') {
                    ctx.scale(-1, 1);
                    ctx.translate(-img.width, 0);
                } else if (flipDirection === 'vertical') {
                    ctx.scale(1, -1);
                    ctx.translate(0, -img.height);
                }
                ctx.drawImage(img, 0, 0, img.width, img.height);
                ctx.restore();
            });
        }

        function applyRotation() {
            const rotateAngle = parseInt(document.getElementById('rotateAngle').value) || 0;

            drawImageWithReset(() => {
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((rotateAngle * Math.PI) / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2, img.width, img.height);
                ctx.restore();
            });
        }

        function applyShear() {
            const shearValue = parseFloat(document.getElementById('shearValue').value) || 0;

            drawImageWithReset(() => {
                ctx.save();
                ctx.transform(1, shearValue, shearValue, 1, 0, 0);
                ctx.drawImage(img, 0, 0, img.width, img.height);
                ctx.restore();
            });
        }

        function applyFisheye() {
            drawImageWithReset(() => {
                const imgData = originalImageData;
                const data = imgData.data;
                const centerX = img.width / 2;
                const centerY = img.height / 2;
                const radius = Math.min(centerX, centerY);
                const output = ctx.createImageData(img.width, img.height);

                for (let y = 0; y < img.height; y++) {
                    for (let x = 0; x < img.width; x++) {
                        const dx = x - centerX;
                        const dy = y - centerY;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < radius) {
                            const factor = Math.pow(distance / radius, 2);
                            const srcX = Math.round(centerX + dx * factor);
                            const srcY = Math.round(centerY + dy * factor);

                            const srcIndex = (srcY * img.width + srcX) * 4;
                            const destIndex = (y * img.width + x) * 4;

                            output.data[destIndex] = data[srcIndex];
                            output.data[destIndex + 1] = data[srcIndex + 1];
                            output.data[destIndex + 2] = data[srcIndex + 2];
                            output.data[destIndex + 3] = data[srcIndex + 3];
                        }
                    }
                }

                ctx.putImageData(output, 0, 0);
            });
        }
    </script>
</body>
</html>
